@page "/"
@using System.Globalization
@using System.Text
@using System.IO
@using OpenHolidaysApi.Model
@using Urlaubsplaner.Client.Services
@using Urlaubsplaner.Client.Models
@using Urlaubsplaner.Client.Helpers

@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@inject ExportService ExportService
@inject StateService StateService
@inject HolidayService HolidayService
@inject VacationCalculationService VacationCalculationService
@inject Microsoft.Extensions.Localization.IStringLocalizer<Index> L
@implements IDisposable

<PageTitle>Urlaubsplaner</PageTitle>

<style>
    .rz-scheduler-nav {
        background-color: #f0f2f5;
        border-radius: 8px;
        padding: 5px;
    }

    .rz-scheduler-view-button {
        border-radius: 20px !important;
    }

    .holiday-legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
    }

    .holiday-legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .info-box {
        background-color: #e3f2fd;
        border-left: 5px solid #2196f3;
        padding: 10px;
        border-radius: 4px;
        min-height: 40px;
        display: flex;
        align-items: center;
    }

    /* Hide internal scrollbars */
    .rz-scheduler-content {
        overflow-y: hidden !important;
        height: 100% !important;
    }

    .rz-view-content {
        height: 100% !important;
        overflow: hidden !important;
    }

    /* Scale down scheduler to fit year view */
    .scheduler-scaler {
        zoom: 0.65; /* Scale down to fit */
        height: 100%;
    }

    @@media (min-width: 1600px) {
        .scheduler-scaler {
            zoom: 0.8;
        }
    }
</style>

<RadzenRow Gap="1rem" RowGap="1rem">
    <RadzenColumn Size="12">
        <RadzenCard Style="background: linear-gradient(to right, #ffffff, #f8f9fa); border-radius: 12px; border: 1px solid #e0e0e0;">
            <RadzenStack Gap="1rem">
                <!-- Header / Title -->
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText Text="@($"Urlaubsplaner {_year}")" TextStyle="TextStyle.H4" Style="margin: 0; color: #2c3e50; font-weight: bold;" />

                    <RadzenStack Orientation="Orientation.Horizontal" Gap="5px" AlignItems="AlignItems.Center">
                        <!-- Client-side Import -->
                        <div class="rz-fileupload" style="display: inline-block;">
                            <div class="rz-fileupload-buttonbar">
                                <label class="rz-button rz-button-sm rz-button-secondary rz-variant-flat" style="margin: 0; cursor: pointer;">
                                    <RadzenIcon Icon="upload" />
                                    <span class="rz-button-text">Import</span>
                                    <InputFile OnChange="@LoadConfigFromFile" style="display: none;" accept=".json" />
                                </label>
                            </div>
                        </div>

                        <RadzenButton Text="Speichern (Lokal)" Icon="save" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Click="@SaveConfigToStorage" Size="ButtonSize.Small" />

                        <RadzenButton Text="Planung zurücksetzen" Icon="delete_sweep" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Click="ClearAllSelections" Size="ButtonSize.Small" />
                        <RadzenSplitButton Text="Exportieren" Icon="file_download" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" Click="@(args => Export(args))" Size="ButtonSize.Small">
                            <ChildContent>
                                <RadzenSplitButtonItem Text="Konfiguration (.json)" Icon="save_as" Value="config_json" />
                                <RadzenSplitButtonItem Text="Kalender (.ics)" Icon="calendar_today" Value="ics" />
                                <RadzenSplitButtonItem Text="CSV" Icon="grid_on" Value="csv" />
                                <RadzenSplitButtonItem Text="JSON (Daten)" Icon="data_object" Value="json" />
                                <RadzenSplitButtonItem Text="In Zwischenablage" Icon="content_copy" Value="clipboard" />
                                <RadzenSplitButtonItem Text="Drucken / PDF" Icon="print" Value="print" />
                            </ChildContent>
                        </RadzenSplitButton>
                    </RadzenStack>
                </RadzenStack>

                <hr style="border: 0; border-top: 1px solid #eee; margin: 0;" />

                <!-- Settings & Configuration -->
                <RadzenRow RowGap="1rem">
                    <!-- Location Settings -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText Text="Standort & Regionen" TextStyle="TextStyle.Subtitle2" Style="color: #666;" />

                            <RadzenLabel Text="Mein Bundesland (Basis für Berechnungen)" Component="PrimaryState" Style="font-size: 0.8rem;" />
                            <RadzenDropDown @bind-Value="_primarySubdivision" Data="_filteredSubdivisions" LoadData="OnSubdivisionLoadData"
                                            AllowFiltering="true" Change="@(async (object args) => await OnPrimaryStateChanged())" TextProperty="@nameof(Subdivision.Name)"
                                            Placeholder="Bitte wählen..." Name="PrimaryState" Style="width: 100%;"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" />

                            <RadzenLabel Text="Vergleichs-Regionen (für Heatmap)" Component="CompareStates" Style="font-size: 0.8rem;" />
                            <RadzenDropDown @bind-Value="_compareSubdivisions" Data="_filteredSubdivisions" LoadData="OnSubdivisionLoadData"
                                            AllowFiltering="true" Change="@(async (object args) => await GetAllMarkings())" TextProperty="@nameof(Subdivision.Name)"
                                            Multiple="true" Chips="true" Placeholder="Weitere wählen..." Name="CompareStates" Style="width: 100%;"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" />

                            <RadzenLabel Text="Zusätzliche Länder" Component="Countries" Style="font-size: 0.8rem;" />
                            <RadzenDropDown @bind-Value="_selectedPublicHolidayCountries" Data="_filteredAdditionalCountries" LoadData="OnCountryLoadData"
                                            AllowFiltering="true" Change="@(async (object args) => await GetAllMarkings())" TextProperty="@nameof(Country.Name)"
                                            Multiple="true" Chips="true" Placeholder="Länder wählen..." Name="Countries" Style="width: 100%;"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" />
                        </RadzenStack>
                    </RadzenColumn>

                    <!-- View & Toggles -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText Text="Ansicht & Filter" TextStyle="TextStyle.Subtitle2" Style="color: #666;" />

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenSwitch @bind-Value="_showHeatmap" Change="@(async (bool args) => await OnToggleChange(args))" />
                                <RadzenLabel Text="Heatmap anzeigen (Ferien-Dichte)" Style="cursor: pointer" @onclick="@(async () => { _showHeatmap = !_showHeatmap; await GetAllMarkings(); })" />
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_showPublicHolidays" Change="@(async (bool args) => await OnToggleChange(args))" />
                                <RadzenLabel Text="Feiertage anzeigen" Style="cursor: pointer" @onclick="@(async () => { _showPublicHolidays = !_showPublicHolidays; await GetAllMarkings(); })" />
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_showSchoolHolidays" Change="@(async (bool args) => await OnToggleChange(args))" />
                                <RadzenLabel Text="Schulferien anzeigen" Style="cursor: pointer" @onclick="@(async () => { _showSchoolHolidays = !_showSchoolHolidays; await GetAllMarkings(); })" />
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_showBridgeDays" Change="@(async (bool args) => await OnToggleChange(args))" />
                                <RadzenLabel Text="Brückentage-Pfeile" Style="cursor: pointer" @onclick="@(async () => { _showBridgeDays = !_showBridgeDays; await GetAllMarkings(); })" />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenColumn>

                    <!-- Stats & Automation -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText Text="Statistik & Planung" TextStyle="TextStyle.Subtitle2" Style="color: #666;" />

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="Urlaubsanspruch:" />
                                <RadzenNumeric @bind-Value="_totalVacationDays" Change="@((decimal args) => OnNumericChange(args))" Step="1" Style="width: 70px; text-align: right;" />
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="Verplant / Rest:" />
                                <div>
                                    <span style="font-weight: bold; color: #1976d2;">@_plannedDays</span> /
                                    <span style="font-weight: bold; color: @((_totalVacationDays - _plannedDays) < 0 ? "red" : "green");">@(_totalVacationDays - _plannedDays)</span>
                                </div>
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="Gleittage geplant:" />
                                <span style="font-weight: bold; color: #7b1fa2;">@_gleittageCount</span>
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="@($"Arbeitstage {_year}:")" />
                                <span style="font-weight: bold;">@_remainingWorkDays</span>
                            </RadzenStack>

                            <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0;" />

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_countWeekendsAndHolidays" Change="@((bool args) => OnToggleCalcChange(args))" />
                                <RadzenLabel Text="Wochenende zählen" Style="cursor: pointer; font-size: 0.8rem;" @onclick="@(() => { _countWeekendsAndHolidays = !_countWeekendsAndHolidays; UpdateAllCalculations(); })" />
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_halfDaysChristmas" Change="@((bool args) => OnToggleCalcChange(args))" />
                                <RadzenLabel Text="24./31.12. halbe Tage" Style="cursor: pointer; font-size: 0.8rem;" @onclick="@(() => { _halfDaysChristmas = !_halfDaysChristmas; UpdateAllCalculations(); })" />
                            </RadzenStack>

                            <RadzenSplitButton Text="Vorschlag generieren" Icon="auto_awesome" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium" Click="@(args => SuggestPerfectVacationWithOptions(args))" Style="width: 100%; margin-top: 5px;">
                                <ChildContent>
                                    <RadzenSplitButtonItem Text="Neuplanung (Alles überschreiben)" Icon="autorenew" Value="overwrite" />
                                    <RadzenSplitButtonItem Text="Ergänzen (Bestehendes behalten)" Icon="add" Value="extend" />
                                    <RadzenSplitButtonItem Text="Ab Heute auffüllen" Icon="clock_arrow_down" Value="rest_of_year" />
                                </ChildContent>
                            </RadzenSplitButton>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>



            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeLG="9" SizeXL="10">
        <RadzenCard style="height: 100vh; max-height: 900px; overflow: hidden; padding: 0;">
            <div class="scheduler-scaler">
                <RadzenScheduler @ref="scheduler" TItem="Marking" Culture="@(CultureInfo.GetCultureInfo("de-DE"))"
                                 SlotRender="SlotRender" SlotSelect="SlotSelect" LoadData="LoadData"
                                 style="height: 100%;" StartProperty="Start" EndProperty="End" TextProperty="Name">
                    <RadzenYearPlannerView @ref="yearPlannerView" />
                    <RadzenYearView @ref="yearView" />
                </RadzenScheduler>
            </div>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeLG="3" SizeXL="2">
        <RadzenCard Style="height: 100vh; max-height: 900px; overflow-y: auto;">
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6">Markieren</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: #666; font-size: 0.8rem;">
                    Wähle einen Modus und klicke dann im Kalender.
                </RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Style="flex-wrap: wrap;">
                    <RadzenButton Text="Urlaub" Icon="beach_access" Size="ButtonSize.Small"
                                  ButtonStyle="@(_inputMode == MarkingInputMode.Vacation ? ButtonStyle.Primary : ButtonStyle.Light)"
                                  Variant="Variant.Flat" Click="@(() => _inputMode = MarkingInputMode.Vacation)" />
                    <RadzenButton Text="Gleittag" Icon="event_available" Size="ButtonSize.Small"
                                  ButtonStyle="@(_inputMode == MarkingInputMode.Gleittag ? ButtonStyle.Primary : ButtonStyle.Light)"
                                  Variant="Variant.Flat" Click="@(() => _inputMode = MarkingInputMode.Gleittag)" />
                    <RadzenButton Text="Notiz" Icon="note" Size="ButtonSize.Small"
                                  ButtonStyle="@(_inputMode == MarkingInputMode.Note ? ButtonStyle.Primary : ButtonStyle.Light)"
                                  Variant="Variant.Flat" Click="@(() => _inputMode = MarkingInputMode.Note)" />
                </RadzenStack>

                @if (_inputMode == MarkingInputMode.Note)
                {
                    <RadzenStack Gap="0.25rem" Style="margin-top: 0.5rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: #666; font-size: 0.8rem;">Notiz-Text (für neue Notizen)</RadzenText>
                        <RadzenTextBox @bind-Value="_defaultNoteText" Placeholder="z.B. Arzt, Geburtstag" Style="width: 100%;" />
                    </RadzenStack>
                }

                <hr />

                <RadzenText TextStyle="TextStyle.H6">Details zum Tag</RadzenText>

                <RadzenCard Variant="Variant.Flat" Class="rz-p-2" Style="background-color: #f8f9fa; min-height: 100px;">
                    @if (string.IsNullOrEmpty(_hoveredInfo))
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; font-style: italic;">
                            Fahre mit der Maus über einen Tag im Kalender, um hier Details zu sehen.
                        </RadzenText>
                    }
                    else
                    {
                        <RadzenText Style="white-space: pre-wrap;">@_hoveredInfo</RadzenText>
                    }
                </RadzenCard>

                <hr style="margin: 0.75rem 0;" />

                <RadzenText TextStyle="TextStyle.H6">Legende</RadzenText>
                <RadzenStack Gap="0.5rem">
                     <div class="holiday-legend-item"><div class="holiday-legend-color" style="background: rgba(40, 167, 69, 0.3); border: 1px solid #28a745;"></div> Urlaub</div>
                     <div class="holiday-legend-item"><div class="holiday-legend-color" style="background: rgba(0, 123, 255, 0.3); border: 1px solid #007bff;"></div> Gleittag</div>
                     <div class="holiday-legend-item"><div class="holiday-legend-color" style="background: rgba(255, 193, 7, 0.35); border: 1px solid #ffc107;"></div> Notiz</div>
                     <div class="holiday-legend-item"><div class="holiday-legend-color" style="background: transparent; border: 3px solid #dc3545;"></div> Feiertag (Mein BL)</div>
                     <div class="holiday-legend-item"><div class="holiday-legend-color" style="background: transparent; border: 3px solid #6f42c1;"></div> Schulferien (Mein BL)</div>
                     <div class="holiday-legend-item"><div class="holiday-legend-color" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMCAxMCc+PHBvbHlnb24gcG9pbnRzPSc1LDAgMTAsNSA1LDEwJyBzdHlsZT0nZmlsbDpvcmFuZ2U7IG9wYWNpdHk6IDAuOScvPjwvc3ZnPg=='); background-repeat: no-repeat; background-position: center; background-size: contain; border: none;"></div> Brückentag</div>
                     <div class="holiday-legend-item"><div class="holiday-legend-color" style="background: linear-gradient(to right, rgba(0,255,0,0.3), rgba(255,255,0,0.3), rgba(255,165,0,0.4), rgba(255,0,0,0.5));"></div> Heatmap (Dichte)</div>
                 </RadzenStack>

            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {

    RadzenScheduler<Marking> scheduler;
    RadzenYearPlannerView yearPlannerView;
    RadzenYearView yearView;
    DotNetObjectReference<Index>? _objRef;

    // Data from Services
    List<Country> _allAdditionalCountries = [];
    IEnumerable<Country> _filteredAdditionalCountries = new List<Country>();
    IEnumerable<Country> _selectedPublicHolidayCountries = new List<Country>();
    
    List<Subdivision> _allSubdivisions = [];
    IEnumerable<Subdivision> _filteredSubdivisions = new List<Subdivision>();
    
    Subdivision? _primarySubdivision;
    IEnumerable<Subdivision> _compareSubdivisions = new List<Subdivision>();

    // Toggles
    bool _showPublicHolidays = true;
    bool _showSchoolHolidays = true;
    bool _showBridgeDays = true;
    bool _showHeatmap = true;
    bool _countWeekendsAndHolidays = false;
    bool _halfDaysChristmas = true;

    // Stats
    decimal _totalVacationDays = 30m;
    decimal _plannedDays;
    int _remainingWorkDays;
    int _gleittageCount;
    int _year = DateTime.Now.Year;

     string _hoveredInfo = "";
     string _defaultNoteText = "";


    enum MarkingInputMode
    {
        Vacation,
        Gleittag,
        Note
    }

    MarkingInputMode _inputMode = MarkingInputMode.Vacation;

    // Data Store
    readonly List<Marking> _markings = [];
    readonly List<Marking> _selectedSlots = [];
    readonly List<Marking> _gleittage = [];
    readonly List<Marking> _notes = [];
    readonly Dictionary<DateTime, int> _dailyHeatScore = new();
    readonly HashSet<DateTime> _overBudgetDates = new();

    int _maxDailyHeatScore = 1;
    Dictionary<int, decimal> _vacationDaysPerYear = new();


    protected override async Task OnInitializedAsync()
    {
        _allAdditionalCountries = await HolidayService.LoadCountriesAsync();
        _filteredAdditionalCountries = _allAdditionalCountries;

        _allSubdivisions = await HolidayService.LoadSubdivisionsAsync();
        _filteredSubdivisions = _allSubdivisions;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var mobile = await JSRuntime.InvokeAsync<bool>("isDevice");
            if (mobile)
            {
                await scheduler.SelectView(yearView);
            }

            // Setup Hover
            _objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("setupSlotHover", _objRef);

            // Load Saved Config
            var config = await StateService.LoadConfigAsync();
            if (config != null)
            {
                ApplyConfig(config);
            }
            else
            {
                UpdateAllCalculations();
            }
        }
    }

    [JSInvokable]
    public void OnSlotHover(string title)
    {
        if (_hoveredInfo != title)
        {
            _hoveredInfo = title;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }

    // --- Events Helpers ---
    async Task OnToggleChange(bool value)
    {
        await SaveConfigToStorage();
        await GetAllMarkings();
    }

    void OnToggleCalcChange(bool value)
    {
        _ = SaveConfigToStorage(); // Fire and forget
        UpdateAllCalculations();
    }

    void OnNumericChange(decimal value)
    {
        _vacationDaysPerYear[_year] = value;
        _ = SaveConfigToStorage(); // Fire and forget
        UpdateAllCalculations();
    }

    // --- Dropdown Load Data ---

    void OnSubdivisionLoadData(LoadDataArgs args)
    {
        var term = args.Filter?.ToLower();
        _filteredSubdivisions = string.IsNullOrEmpty(term) ? _allSubdivisions : _allSubdivisions.Where(s => s.SearchKeywords.Contains(term));
        InvokeAsync(StateHasChanged);
    }

    void OnCountryLoadData(LoadDataArgs args)
    {
        var term = args.Filter?.ToLower();
        _filteredAdditionalCountries = string.IsNullOrEmpty(term) ? _allAdditionalCountries : _allAdditionalCountries.Where(c => c.SearchKeywords.Contains(term));
        InvokeAsync(StateHasChanged);
    }

    async Task OnPrimaryStateChanged()
    {
        _filteredSubdivisions = _allSubdivisions;
        await SaveConfigToStorage();
        await GetAllMarkings();
    }

    private async Task GetAllMarkings()
    {
        _markings.Clear();
        _dailyHeatScore.Clear();
        _maxDailyHeatScore = 1;

        var startDate = scheduler.SelectedView.StartDate;
        var endDate = scheduler.SelectedView.EndDate;

        if (_primarySubdivision != null)
        {
            if (_showPublicHolidays)
            {
                var ph = await HolidayService.FetchHolidaysCached("DE", startDate, endDate, _primarySubdivision.Code, false);
                foreach (var h in ph) AddMarking(h, _primarySubdivision.Name, MarkingType.PublicHoliday, 3);
            }
            if (_showSchoolHolidays)
            {
                var sh = await HolidayService.FetchHolidaysCached("DE", startDate, endDate, _primarySubdivision.Code, true);
                foreach (var h in sh) AddMarking(h, _primarySubdivision.Name, MarkingType.SchoolHoliday, 1);
            }
        }

        if (_compareSubdivisions != null && _compareSubdivisions.Any())
        {
            foreach (var sub in _compareSubdivisions)
            {
                if (sub.Code == _primarySubdivision?.Code) continue;

                if (_showPublicHolidays)
                {
                    var ph = await HolidayService.FetchHolidaysCached("DE", startDate, endDate, sub.Code, false);
                    foreach (var h in ph) AddMarking(h, sub.Name, MarkingType.PublicHolidayCompare, 2);
                }
                if (_showSchoolHolidays)
                {
                    var sh = await HolidayService.FetchHolidaysCached("DE", startDate, endDate, sub.Code, true);
                    foreach (var h in sh) AddMarking(h, sub.Name, MarkingType.SchoolHolidayCompare, 1);
                }
            }
        }

        if (_selectedPublicHolidayCountries != null && _selectedPublicHolidayCountries.Any())
        {
            foreach (var c in _selectedPublicHolidayCountries)
            {
                if (_showPublicHolidays)
                {
                    var ph = await HolidayService.FetchHolidaysCached(c.IsoCode, startDate, endDate, null, false);
                    foreach (var h in ph.Where(p => p.Nationwide == true)) AddMarking(h, c.Name, MarkingType.PublicHolidayCompare, 2);
                }
            }
        }

        if (_showBridgeDays && _primarySubdivision != null)
        {
            _markings.AddRange(VacationCalculationService.CalculateBridgeDays(startDate, endDate, _markings));
        }

        if (_dailyHeatScore.Any())
        {
            _maxDailyHeatScore = _dailyHeatScore.Values.Max();
        }

        UpdateAllCalculations();
        await scheduler.Reload();
    }

    private void UpdateAllCalculations()
    {
        (_plannedDays, _gleittageCount) = VacationCalculationService.CalculatePlannedDays(
            _selectedSlots, 
            _gleittage, 
            _markings, 
            _halfDaysChristmas);

        _remainingWorkDays = VacationCalculationService.CalculateRemainingWorkDays(
            _year,
            _selectedSlots,
            _gleittage,
            _markings,
            _countWeekendsAndHolidays);

        // Calculate Over Budget Dates (Insertion Order)
        _overBudgetDates.Clear();
        decimal currentCost = 0;

        var primaryHolidays = _markings
            .Where(m => m.Type == MarkingType.PublicHoliday)
            .SelectMany(m => Enumerable.Range(0, (m.End.Date - m.Start.Date).Days + 1).Select(d => m.Start.Date.AddDays(d)))
            .ToHashSet();

        foreach (var slot in _selectedSlots)
        {
            var date = slot.Start.Date;
            bool isWeekend = date.DayOfWeek is DayOfWeek.Saturday or DayOfWeek.Sunday;
            bool isHoliday = primaryHolidays.Contains(date);

            if (!isWeekend && !isHoliday)
            {
                decimal cost = (_halfDaysChristmas && (date.Month == 12 && date.Day >= 24 && date.Day <= 31)) ? 0.5m : 1.0m;
                currentCost += cost;

                if (currentCost > _totalVacationDays)
                {
                    _overBudgetDates.Add(date);
                }
            }
        }
    }

    private void AddMarking(HolidayResponse h, string subName, MarkingType type, int score)
    {
        if (!h.StartDate.HasValue || !h.EndDate.HasValue) return;

        var start = h.StartDate.Value.Date;
        var end = h.EndDate.Value.Date;

        _markings.Add(new Marking
        {
            Start = start,
            End = end.AddHours(23),
            Name = h.Name.First().Text,
            SubdivisionName = subName,
            Type = type
        });

        for (var d = start; d <= end; d = d.AddDays(1))
        {
            _dailyHeatScore.TryAdd(d, 0);
            _dailyHeatScore[d] += score;
        }
    }

    private string GetHeatmapColor(int score)
    {
        if (score == 0) return "transparent";

        double saturation = 12.0;
        double denominator = Math.Min(Math.Max(_maxDailyHeatScore, 5), saturation); 
        double percent = Math.Min(score / denominator, 1.0);

        int r, g, b;
        double alpha = 0.3 + (percent * 0.2); // Less opacity overall (0.3 to 0.5)

        // Multi-stop gradient: Green -> Yellow -> Orange -> Red
        // 0.00 - 0.33: Green (0,255,0) -> Yellow (255,255,0)
        // 0.33 - 0.66: Yellow (255,255,0) -> Orange (255,165,0)
        // 0.66 - 1.00: Orange (255,165,0) -> Red (255,0,0)

        if (percent < 0.33)
        {
            // Green to Yellow
            var p = percent / 0.33;
            r = (int)(p * 255);
            g = 255;
            b = 0;
        }
        else if (percent < 0.66)
        {
            // Yellow to Orange
            var p = (percent - 0.33) / 0.33;
            r = 255;
            g = (int)(255 - (p * (255 - 165))); // G goes 255 -> 165
            b = 0;
        }
        else
        {
            // Orange to Red
            var p = (percent - 0.66) / 0.34;
            r = 255;
            g = (int)(165 - (p * 165)); // G goes 165 -> 0
            b = 0;
        }

        return $"rgba({r}, {g}, {b}, {alpha.ToString(CultureInfo.InvariantCulture)})";
    }

    private void SlotRender(SchedulerSlotRenderEventArgs args)
    {
        var date = args.Start.Date;
        var style = new StringBuilder();
        var bgImages = new List<string>();
        var bgPositions = new List<string>();
        var bgSizes = new List<string>();
        var info = new List<string>();

        if (_showHeatmap && _dailyHeatScore.TryGetValue(date, out int score))
        {
            style.Append($"background-color: {GetHeatmapColor(score)};");
        }

        if (date.DayOfWeek is DayOfWeek.Saturday or DayOfWeek.Sunday)
        {
            bgImages.Add("linear-gradient(rgba(0,0,0,0.05), rgba(0,0,0,0.05))");
            bgPositions.Add("center");
            bgSizes.Add("contain");
        }

        var dayMarkings = _markings.Where(m => m.Start.Date <= date && m.End.Date >= date).ToList();

        var primaryPH = dayMarkings.FirstOrDefault(m => m.Type == MarkingType.PublicHoliday);
        if (primaryPH != null)
        {
            style.Append("box-shadow: inset 0 0 0 3px #dc3545;");
            info.Add($"★ {primaryPH.Name}");
        }
        else
        {
            var primarySH = dayMarkings.FirstOrDefault(m => m.Type == MarkingType.SchoolHoliday);
            if (primarySH != null)
            {
                style.Append("box-shadow: inset 0 0 0 3px #6f42c1;");
                info.Add($"Ferien: {primarySH.Name}");
            }
        }

        info.AddRange(dayMarkings.Where(x => x.Type is MarkingType.PublicHolidayCompare or MarkingType.SchoolHolidayCompare).Select(m => $"{m.Name} ({m.SubdivisionName})"));

         var selection = _selectedSlots.FirstOrDefault(s => s.Start.Date == date);
         if (selection != null)
         {
             bool isOverBudget = _overBudgetDates.Contains(date);
             string bgColor = isOverBudget ? "rgba(220, 53, 69, 0.15)" : "rgba(40, 167, 69, 0.15)";

             bgImages.Add($"linear-gradient({bgColor}, {bgColor})");
             bgPositions.Add("center");
             bgSizes.Add("contain");

             // Icon: beach_access (Umbrella)
             string vacationSvg = isOverBudget
                 ? "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23dc3545' d='M13.127 14.56l1.96-1.96 6.11 6.11-1.96 1.96-6.11-6.11zm-3.909 1.761l2.546-2.546-3.741-3.741-2.546 2.546 3.741 3.741zm10.272-10.272l-3.264-3.264c-.351-.351-.919-.351-1.272 0l-12.72 12.72c-.351.351-.351.919 0 1.272l3.264 3.264c.351.351.919.351 1.272 0l12.72-12.72c.351-.351.351-.92 0-1.272zm-7.636 1.195l3.741 3.741-2.546 2.546-3.741-3.741 2.546-2.546z' opacity='0.4'/></svg>"
                 : "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2328a745' d='M13.127 14.56l1.96-1.96 6.11 6.11-1.96 1.96-6.11-6.11zm-3.909 1.761l2.546-2.546-3.741-3.741-2.546 2.546 3.741 3.741zm10.272-10.272l-3.264-3.264c-.351-.351-.919-.351-1.272 0l-12.72 12.72c-.351.351-.351.919 0 1.272l3.264 3.264c.351.351.919.351 1.272 0l12.72-12.72c.351-.351.351-.92 0-1.272zm-7.636 1.195l3.741 3.741-2.546 2.546-3.741-3.741 2.546-2.546z' opacity='0.4'/></svg>";
             
             bgImages.Add($"url('data:image/svg+xml;base64,{Convert.ToBase64String(Encoding.UTF8.GetBytes(vacationSvg))}')");
             bgPositions.Add("center");
             bgSizes.Add("70%"); 

             info.Add(isOverBudget ? "Geplanter Urlaub (Über Budget!)" : "Geplanter Urlaub");
         }

         var gleittag = _gleittage.FirstOrDefault(s => s.Start.Date == date);
         if (gleittag != null)
         {
             // Icon: event_available (Calendar Check)
             const string gSvg = "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23007bff' d='M16.53 11.06L15.47 10l-4.88 4.88-2.12-2.12-1.06 1.06L10.59 16l5.94-4.94zM19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z' opacity='0.4'/></svg>";
             bgImages.Add($"url('data:image/svg+xml;base64,{Convert.ToBase64String(Encoding.UTF8.GetBytes(gSvg))}')");
             bgPositions.Add("center");
             bgSizes.Add("70%");

             info.Add("Gleittag");
         }


         var note = _notes.FirstOrDefault(s => s.Start.Date == date);
         if (note != null)
         {
             string bgColor = "rgba(255, 193, 7, 0.35)";
             bgImages.Add($"linear-gradient({bgColor}, {bgColor})");
             bgPositions.Add("center");
             bgSizes.Add("contain");

             const string noteSvg = "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23ffc107' d='M3 5a2 2 0 0 1 2-2h10l6 6v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5zm12 0v5h5' opacity='0.95'/><path fill='%238a6d00' d='M6 13h12v2H6v-2zm0 4h10v2H6v-2z' opacity='0.9'/></svg>";
             bgImages.Add($"url('data:image/svg+xml;base64,{Convert.ToBase64String(Encoding.UTF8.GetBytes(noteSvg))}')");
             bgPositions.Add("top right");
             bgSizes.Add("12px 12px");

             info.Add(string.IsNullOrWhiteSpace(note.Name) ? "Notiz" : $"Notiz: {note.Name}");
         }


        if (_showBridgeDays && dayMarkings.Any(m => m.Type == MarkingType.BridgeDay))
        {
            var arrowSvg = date.DayOfWeek switch
            {
                DayOfWeek.Monday or DayOfWeek.Tuesday => "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'><polygon points='5,0 0,5 5,10' style='fill:orange; opacity: 0.9'/></svg>",
                DayOfWeek.Thursday or DayOfWeek.Friday => "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'><polygon points='5,0 10,5 5,10' style='fill:orange; opacity: 0.9'/></svg>",
                _ => ""
            };
            if (!string.IsNullOrEmpty(arrowSvg))
            {
                bgImages.Add($"url('data:image/svg+xml;base64,{Convert.ToBase64String(Encoding.UTF8.GetBytes(arrowSvg))}')");
                bgPositions.Add("center");
                bgSizes.Add("contain");
                info.Add("Möglicher Brückentag");
            }
        }

        if (date < DateTime.Today)
        {
            style.Append("opacity: 0.5; filter: grayscale(0.5); ");
        }

        if (bgImages.Any())
        {
            style.Append($"background-image: {string.Join(", ", bgImages)}; ");
            style.Append($"background-position: {string.Join(", ", bgPositions)}; ");
            style.Append($"background-size: {string.Join(", ", bgSizes)}; ");
            style.Append("background-repeat: no-repeat; ");
        }

        args.Attributes["style"] = style.ToString();

        if (info.Any())
        {
            args.Attributes["title"] = string.Join("\n", info.Distinct());
        }
    }

    private async Task SlotSelect(SchedulerSlotSelectEventArgs args)
    {
        args.PreventDefault();
        var date = args.Start.Date;

        var existingSel = _selectedSlots.FirstOrDefault(s => s.Start.Date == date);
        var existingGleit = _gleittage.FirstOrDefault(s => s.Start.Date == date);
        var existingNote = _notes.FirstOrDefault(s => s.Start.Date == date);

        switch (_inputMode)
        {
            case MarkingInputMode.Vacation:
                if (existingSel != null)
                {
                    _selectedSlots.Remove(existingSel);
                }
                else
                {
                    _gleittage.RemoveAll(s => s.Start.Date == date);
                    _notes.RemoveAll(s => s.Start.Date == date);
                    _selectedSlots.Add(new Marking { Start = date, End = date.AddDays(1), Name = "Urlaub", Type = MarkingType.Selected });
                }
                break;

            case MarkingInputMode.Gleittag:
                if (existingGleit != null)
                {
                    _gleittage.Remove(existingGleit);
                }
                else
                {
                    _selectedSlots.RemoveAll(s => s.Start.Date == date);
                    _notes.RemoveAll(s => s.Start.Date == date);
                    _gleittage.Add(new Marking { Start = date, End = date.AddDays(1), Name = "Gleittag", Type = MarkingType.Gleittag });
                }
                break;

             case MarkingInputMode.Note:
                 if (existingNote != null)
                 {
                     _notes.Remove(existingNote);
                 }
                 else
                 {
                     _selectedSlots.RemoveAll(s => s.Start.Date == date);
                     _gleittage.RemoveAll(s => s.Start.Date == date);
                     var text = string.IsNullOrWhiteSpace(_defaultNoteText) ? "Notiz" : _defaultNoteText.Trim();
                     _notes.Add(new Marking { Start = date, End = date.AddDays(1), Name = text, Type = MarkingType.Note });
                 }
                 break;
        }

        await SaveConfigToStorage();
        UpdateAllCalculations();
        await scheduler.Reload();
    }

    async Task LoadConfigFromFile(InputFileChangeEventArgs e)
    {
        try
        {
            using var reader = new StreamReader(e.File.OpenReadStream());
            var json = await reader.ReadToEndAsync();
            var config = StateService.ImportConfigFromJson(json);
            if (config != null)
            {
                ApplyConfig(config);
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Import erfolgreich", Detail = "Konfiguration wurde geladen." });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Import Fehler", Detail = "Datei konnte nicht gelesen werden." });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Import Fehler", Detail = ex.Message });
        }
    }

    async Task SuggestPerfectVacationWithOptions(RadzenSplitButtonItem? args)
    {
        if (_primarySubdivision == null)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = "Fehler", Detail = "Bitte wählen Sie zuerst Ihr Bundesland aus." });
            return;
        }

        // Default to "extend" if main button clicked (args is null)
        string value = args?.Value ?? "extend";

        bool overwrite = value == "overwrite";
        bool planFromToday = value == "rest_of_year";

        var preferences = await DialogService.OpenAsync<PlanningPreferencesDialog>("Planungs-Einstellungen", null,
            new DialogOptions { Width = "500px", Height = "auto", Resizable = false, Draggable = true });
        if (preferences == null) return;
        var prefs = (PlanningPreferences)preferences;

        var suggestedBlocks = await VacationCalculationService.SuggestPerfectVacation(
            prefs,
            _primarySubdivision,
            _totalVacationDays,
            _plannedDays,
            _halfDaysChristmas,
            overwrite,
            planFromToday,
            _year,
            _selectedSlots.ToList()
        );

        if (suggestedBlocks.Any())
        {
            var result = await DialogService.OpenAsync<SuggestionDialog>("Optimaler Urlaubsplan",
                new Dictionary<string, object> { { "SuggestionBlocks", suggestedBlocks } },
                new DialogOptions { Width = "90vw", Height = "auto", Resizable = true, Draggable = true });

            if (result == true)
            {
                if (overwrite)
                {
                    _selectedSlots.Clear();
                    _gleittage.Clear();
                    _notes.Clear();
                }
                var allSuggestedDays = suggestedBlocks.SelectMany(b => b.VacationDays);
                foreach (var day in allSuggestedDays)
                {
                    if (_selectedSlots.All(s => s.Start.Date != day.Date))
                    {
                        _selectedSlots.Add(new Marking { Start = day.Date, End = day.Date.AddDays(1), Name = "Urlaub", Type = MarkingType.Selected });
                    }
                }

                await SaveConfigToStorage();
                UpdateAllCalculations();
                await scheduler.Reload();
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Kein Vorschlag", Detail = "Es konnten keine passenden Zeiträume für die gewählten Kriterien gefunden werden.", Duration = 4000 });
        }
    }

    async Task ClearAllSelections()
    {
        var result = await DialogService.Confirm("Möchten Sie wirklich alle Planungen löschen?", "Planung zurücksetzen", new ConfirmOptions() { OkButtonText = "Ja", CancelButtonText = "Nein" });
        if (result == true)
        {
        _selectedSlots.Clear();
        _gleittage.Clear();
        _notes.Clear();
        await SaveConfigToStorage();
        UpdateAllCalculations();
        await scheduler.Reload();

        }
    }

    async Task LoadData(SchedulerLoadDataEventArgs args)
    {
        var middle = args.Start.AddTicks((args.End - args.Start).Ticks / 2).Year;
        if (_year != middle)
        {
            _year = middle;
            
            // Switch vacation days context
            if (!_vacationDaysPerYear.ContainsKey(_year))
            {
                _vacationDaysPerYear[_year] = 30; // Default
            }
            _totalVacationDays = _vacationDaysPerYear[_year];
            
            await GetAllMarkings();
            UpdateAllCalculations();
        }
    }

    // --- Import/Export & Config ---

    async Task SaveConfigToStorage()
    {
        var config = new PlanningConfig
        {
            PrimarySubdivisionCode = _primarySubdivision?.Code,
            CompareSubdivisionCodes = _compareSubdivisions?.Select(s => s.Code).ToList(),
            CountryCodes = _selectedPublicHolidayCountries?.Select(c => c.IsoCode).ToList(),
            ShowPublicHolidays = _showPublicHolidays,
            ShowSchoolHolidays = _showSchoolHolidays,
            ShowBridgeDays = _showBridgeDays,
            ShowHeatmap = _showHeatmap,
            CountWeekendsAndHolidays = _countWeekendsAndHolidays,
            HalfDaysChristmas = _halfDaysChristmas,
            TotalVacationDaysPerYear = _vacationDaysPerYear,
            SelectedSlots = _selectedSlots.Select(s => new MarkingDto { Start = s.Start, End = s.End, Name = s.Name, Type = (int)s.Type }).ToList(),
            Gleittage = _gleittage.Select(s => new MarkingDto { Start = s.Start, End = s.End, Name = s.Name, Type = (int)s.Type }).ToList(),
            Notes = _notes.Select(s => new MarkingDto { Start = s.Start, End = s.End, Name = s.Name, Type = (int)s.Type }).ToList()
        };
        await StateService.SaveConfigAsync(config);
    }

    void ApplyConfig(PlanningConfig config)
    {
        if (config.PrimarySubdivisionCode != null)
            _primarySubdivision = _allSubdivisions.FirstOrDefault(s => s.Code == config.PrimarySubdivisionCode);

        if (config.CompareSubdivisionCodes != null)
            _compareSubdivisions = _allSubdivisions.Where(s => config.CompareSubdivisionCodes.Contains(s.Code)).ToList();

        if (config.CountryCodes != null)
            _selectedPublicHolidayCountries = _allAdditionalCountries.Where(c => config.CountryCodes.Contains(c.IsoCode)).ToList();

        _showPublicHolidays = config.ShowPublicHolidays;
        _showSchoolHolidays = config.ShowSchoolHolidays;
        _showBridgeDays = config.ShowBridgeDays;
        _showHeatmap = config.ShowHeatmap;
        _countWeekendsAndHolidays = config.CountWeekendsAndHolidays;
        _halfDaysChristmas = config.HalfDaysChristmas;
        
        _vacationDaysPerYear = config.TotalVacationDaysPerYear ?? new Dictionary<int, decimal>();
        
        // Fallback for migration
        if (!_vacationDaysPerYear.ContainsKey(_year))
        {
             _vacationDaysPerYear[_year] = config.TotalVacationDays > 0 ? config.TotalVacationDays : 30;
        }
        _totalVacationDays = _vacationDaysPerYear.GetValueOrDefault(_year, 30);

        _selectedSlots.Clear();
        if (config.SelectedSlots != null)
            _selectedSlots.AddRange(config.SelectedSlots.Select(d => new Marking { Start = d.Start, End = d.End, Name = d.Name, Type = (MarkingType)d.Type }));

        _gleittage.Clear();
        if (config.Gleittage != null)
            _gleittage.AddRange(config.Gleittage.Select(d => new Marking { Start = d.Start, End = d.End, Name = d.Name, Type = (MarkingType)d.Type }));

        _notes.Clear();
        if (config.Notes != null)
            _notes.AddRange(config.Notes.Select(d => new Marking { Start = d.Start, End = d.End, Name = d.Name, Type = (MarkingType)d.Type }));

        _ = GetAllMarkings();
    }

     async Task Export(RadzenSplitButtonItem? args)
     {
         if (args == null) return; // Do nothing if main button clicked without a specific value

         if (args.Value == "config_json")
         {
             await SaveConfigToStorage(); // Ensure latest state
             var config = await StateService.LoadConfigAsync();
             if (config != null)
             {
                 var json = StateService.ExportConfigToJson(config);
                 await ExportService.DownloadFile("urlaubsplaner_config.json", "application/json", json);
             }
             return;
         }

         var result = await DialogService.OpenAsync<ExportOptionsDialog>("Export-Optionen", null,
             new DialogOptions { Width = "420px", Height = "auto", Resizable = false, Draggable = true });

         if (result == null) return;

         var options = (ExportOptionsDialog.ExportOptions)result;

         var items = new List<ExportService.ExportItem>();

         if (options.ExportVacation)
         {
             items.AddRange(_selectedSlots.Select(s => new ExportService.ExportItem
             {
                 Start = s.Start.Date,
                 End = s.End.Date,
                 Title = "Urlaub",
                 Category = "Urlaub"
             }));
         }

         if (options.ExportGleittage)
         {
             items.AddRange(_gleittage.Select(s => new ExportService.ExportItem
             {
                 Start = s.Start.Date,
                 End = s.End.Date,
                 Title = "Gleittag",
                 Category = "Gleittag"
             }));
         }

         if (options.ExportNotes)
         {
             items.AddRange(_notes.Select(s => new ExportService.ExportItem
             {
                 Start = s.Start.Date,
                 End = s.End.Date,
                 Title = string.IsNullOrWhiteSpace(s.Name) ? "Notiz" : s.Name,
                 Category = "Notiz"
             }));
         }

         if (!items.Any())
         {
             NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = "Nichts zu exportieren", Detail = "Bitte wählen Sie mindestens eine Kategorie mit Daten." });
             return;
         }

         switch (args.Value)
         {
             case "ics":
                 var ics = ExportService.GenerateIcs(items);
                 await ExportService.DownloadFile("Urlaubsplaner.ics", "text/calendar", ics);
                 break;
             case "csv":
                 var csv = ExportService.GenerateCsv(items);
                 await ExportService.DownloadFile("Urlaubsplaner.csv", "text/csv", csv);
                 break;
             case "json":
                 var json = ExportService.GenerateJson(items);
                 await ExportService.DownloadFile("Urlaubsplaner.json", "application/json", json);
                 break;
             case "clipboard":
                 var text = ExportService.GenerateSummaryText(items);
                 await ExportService.CopyToClipboard(text);
                 NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Kopiert", Detail = "Exportdaten in Zwischenablage kopiert." });
                 break;
             case "print":
                 await JSRuntime.InvokeVoidAsync("print");
                 break;
         }
     }


}