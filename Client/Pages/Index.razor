@page "/"
@using System.Globalization
@using System.Text
@using System.IO
@using OpenHolidaysApi.Model
@using Urlaubsplaner.Client.Services
@using Urlaubsplaner.Client.Models

@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@inject ExportService ExportService
@inject StateService StateService
@inject HolidayService HolidayService
@inject OpenHolidaysBootstrapState OpenHolidaysBootstrapState
@inject VacationCalculationService VacationCalculationService
@inject Microsoft.Extensions.Localization.IStringLocalizer<Index> L
@inject TooltipService tooltipService
@implements IDisposable

<PageTitle>Urlaubsplaner</PageTitle>

<style>
    .rz-scheduler-nav {
        background-color: #f0f2f5;
        border-radius: 8px;
        padding: 5px;
    }

    .rz-scheduler-view-button {
        border-radius: 20px !important;
    }

    .holiday-legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
    }

    .holiday-legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .info-box {
        background-color: #e3f2fd;
        border-left: 5px solid #2196f3;
        padding: 10px;
        border-radius: 4px;
        min-height: 40px;
        display: flex;
        align-items: center;
    }

    /* Hide internal scrollbars */
    .rz-scheduler-content {
        overflow-y: hidden !important;
        height: 100% !important;
    }

    .rz-view-content {
        height: 100% !important;
        overflow: hidden !important;
    }

    /* Scale down scheduler to fit year view */
    .scheduler-scaler {
        zoom: 0.65; /* Scale down to fit */
        height: 100%;
    }

    @@media (min-width: 1600px) {
        .scheduler-scaler {
            zoom: 0.8;
        }
    }

    /* Slot icons: use multiple overlays to keep per-icon colors */
    .holiday-slot-icon {
        position: relative;
    }

        .holiday-slot-icon::after,
        .holiday-slot-icon::before {
            content: "";
            position: absolute;
            inset: 0;
            background-repeat: no-repeat;
            pointer-events: none;
        }

        /* Base (larger) icon layer (vacation/gleittag) */
        .holiday-slot-icon::after {
            background-image: var(--holiday-icon-url);
            background-position: var(--holiday-icon-position, center);
            background-size: var(--holiday-icon-size, 62%);
            filter: var(--holiday-icon-filter, none);
        }

        /* Secondary (small) icon layer (note when combined) */
        .holiday-slot-icon::before {
            background-image: var(--holiday-icon-url-secondary);
            background-position: var(--holiday-icon-position-secondary, center);
            background-size: var(--holiday-icon-size-secondary, 48%);
            filter: var(--holiday-icon-filter-secondary, none);
        }

    .holiday-legend-icon {
        width: 1.1rem;
        height: 1.1rem;
        display: inline-block;
        vertical-align: text-bottom;
        background-image: var(--holiday-icon-url);
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        filter: var(--holiday-icon-filter, none);
    }
</style>

<RadzenRow Gap="1rem" RowGap="1rem">
    <RadzenColumn Size="12">
        <RadzenCard Style="background: linear-gradient(to right, #ffffff, #f8f9fa); border-radius: 12px; border: 1px solid #e0e0e0;">
            <RadzenStack Gap="1rem">
                <!-- Header / Title -->
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText Text="@($"Urlaubsplaner {_year}")" TextStyle="TextStyle.H4" Style="margin: 0; color: #2c3e50; font-weight: bold;" />

                    <RadzenStack Orientation="Orientation.Horizontal" Gap="5px" AlignItems="AlignItems.Center">
                        <!-- Client-side Import -->
                        <div class="rz-fileupload" style="display: inline-block;">
                            <div class="rz-fileupload-buttonbar">
                                <label class="rz-button rz-button-sm rz-button-secondary rz-variant-flat" style="margin: 0; cursor: pointer;">
                                    <RadzenIcon Icon="upload" />
                                    <span class="rz-button-text">Import</span>
                                    <InputFile OnChange="@LoadConfigFromFile" style="display: none;" accept=".json" />
                                </label>
                            </div>
                        </div>

                        <RadzenButton Text="Speichern (Lokal)" Icon="save" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Click="@SaveConfigToStorage" Size="ButtonSize.Small" />

                        <RadzenButton Text="Planung zurücksetzen" Icon="delete_sweep" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Click="ClearAllSelections" Size="ButtonSize.Small" />
                        <RadzenSplitButton Text="Exportieren" Icon="file_download" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" Click="@(args => Export(args))" Size="ButtonSize.Small">
                            <ChildContent>
                                <RadzenSplitButtonItem Text="Konfiguration (.json)" Icon="save_as" Value="config_json" />
                                <RadzenSplitButtonItem Text="Kalender (.ics)" Icon="calendar_today" Value="ics" />
                                <RadzenSplitButtonItem Text="CSV" Icon="grid_on" Value="csv" />
                                <RadzenSplitButtonItem Text="JSON (Daten)" Icon="data_object" Value="json" />
                                <RadzenSplitButtonItem Text="In Zwischenablage" Icon="content_copy" Value="clipboard" />
                                <RadzenSplitButtonItem Text="Drucken / PDF" Icon="print" Value="print" />
                            </ChildContent>
                        </RadzenSplitButton>
                    </RadzenStack>
                </RadzenStack>

                <hr style="border: 0; border-top: 1px solid #eee; margin: 0;" />

                <!-- Settings & Configuration -->
                <RadzenRow RowGap="1rem">
                    <!-- Location Settings -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText Text="Standort & Regionen" TextStyle="TextStyle.Subtitle2" Style="color: #666;" />

                            <RadzenLabel Text="Mein Bundesland (Basis für Berechnungen)" Component="PrimaryState" Style="font-size: 0.8rem;" />
                            <RadzenDropDown @bind-Value="_primarySubdivision" Data="_filteredSubdivisions" LoadData="OnSubdivisionLoadData"
                                            AllowFiltering="true" Change="@(async (object args) => await OnPrimaryStateChanged())" TextProperty="@nameof(Subdivision.Name)"
                                            Disabled="@(!_openHolidaysApiAvailable)"
                                            Placeholder="@( _openHolidaysApiAvailable ? "Bitte wählen..." : "API offline" )" Name="PrimaryState" Style="width: 100%;"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" />

                            <RadzenLabel Text="Vergleichs-Regionen (für Heatmap)" Component="CompareStates" Style="font-size: 0.8rem;" />
                            <RadzenDropDown @bind-Value="_compareSubdivisions" Data="_filteredSubdivisions" LoadData="OnSubdivisionLoadData"
                                            AllowFiltering="true" Change="@(async (object args) => await OnCompareStatesChanged())" TextProperty="@nameof(Subdivision.Name)"
                                            Disabled="@(!_openHolidaysApiAvailable)"
                                            Multiple="true" Chips="true" Placeholder="@( _openHolidaysApiAvailable ? "Weitere wählen..." : "API offline" )" Name="CompareStates" Style="width: 100%;"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" />

                            <RadzenLabel Text="Zusätzliche Länder" Component="Countries" Style="font-size: 0.8rem;" />
                            <RadzenDropDown @bind-Value="_selectedPublicHolidayCountries" Data="_filteredAdditionalCountries" LoadData="OnCountryLoadData"
                                            AllowFiltering="true" Change="@(async (object args) => await OnCountriesChanged())" TextProperty="@nameof(Country.Name)"
                                            Disabled="@(!_openHolidaysApiAvailable)"
                                            Multiple="true" Chips="true" Placeholder="@( _openHolidaysApiAvailable ? "Länder wählen..." : "API offline" )" Name="Countries" Style="width: 100%;"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" />
                        </RadzenStack>
                    </RadzenColumn>

                    <!-- View & Toggles -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText Text="Ansicht & Filter" TextStyle="TextStyle.Subtitle2" Style="color: #666;" />

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenSwitch @bind-Value="_showHeatmap" Change="@(async (bool args) => await OnToggleChange(args))" />
                                <RadzenLabel Text="Heatmap anzeigen (Ferien-Dichte)" Style="cursor: pointer" @onclick="@(async () => { _showHeatmap = !_showHeatmap; await GetAllMarkings(); })" />
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_showPublicHolidays" Change="@(async (bool args) => await OnToggleChange(args))" />
                                <RadzenLabel Text="Feiertage anzeigen" Style="cursor: pointer" @onclick="@(async () => { _showPublicHolidays = !_showPublicHolidays; await GetAllMarkings(); })" />
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_showSchoolHolidays" Change="@(async (bool args) => await OnToggleChange(args))" />
                                <RadzenLabel Text="Schulferien anzeigen" Style="cursor: pointer" @onclick="@(async () => { _showSchoolHolidays = !_showSchoolHolidays; await GetAllMarkings(); })" />
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_showBridgeDays" Change="@(async (bool args) => await OnToggleChange(args))" />
                                <RadzenLabel Text="Brückentage-Pfeile" Style="cursor: pointer" @onclick="@(async () => { _showBridgeDays = !_showBridgeDays; await GetAllMarkings(); })" />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenColumn>

                    <!-- Stats & Automation -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.5rem">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText Text="Statistik & Planung" TextStyle="TextStyle.Subtitle2" Style="color: #666;" />
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="5px">
                                    <RadzenLabel Text="Urlaubsanspruch:" Style="font-size: 0.8rem;" />
                                    <RadzenNumeric @bind-Value="_totalVacationDays" Change="@((decimal args) => OnNumericChange(args))" Step="1" Style="width: 60px; text-align: right;" />
                                </RadzenStack>
                            </RadzenStack>

                            <div class="stat-box stat-box-primary">
                                <RadzenIcon Icon="event" class="stat-icon" Style="color: #1976d2;" />
                                <div class="stat-content">
                                    <div class="stat-label">Verplante Urlaubstage</div>
                                    <div class="stat-value" style="color: #1976d2;">@_plannedDays</div>
                                </div>
                            </div>

                            <div class="stat-box stat-box-success">
                                <RadzenIcon Icon="check_circle" class="stat-icon" Style="color: @((_totalVacationDays - _plannedDays) < 0 ? "#d32f2f" : "#4caf50");" />
                                <div class="stat-content">
                                    <div class="stat-label">Verbleibende Urlaubstage</div>
                                    <div class="stat-value" style="color: @((_totalVacationDays - _plannedDays) < 0 ? "#d32f2f" : "#4caf50");">@(_totalVacationDays - _plannedDays)</div>
                                </div>
                            </div>

                            <RadzenRow>
                                <RadzenColumn Size="6">
                                    <div class="stat-box stat-box-purple" style="padding: 8px;">
                                        <div class="stat-content">
                                            <div class="stat-label" style="display: flex; align-items: center; gap: 4px;">
                                                Gleittage
                                                <RadzenIcon Icon="info" class="help-icon" Style="font-size: 0.9rem;" MouseEnter="@(args => ShowTooltip(args, "Gleittage sind flexible Arbeitszeitausgleichstage, die Sie durch Überstunden ansammeln können."))" />
                                            </div>
                                            <div class="stat-value" style="color: #7b1fa2; font-size: 1.3rem;">@_gleittageCount</div>
                                        </div>
                                    </div>
                                </RadzenColumn>
                                <RadzenColumn Size="6">
                                    <div class="stat-box stat-box-warning" style="padding: 8px;">
                                        <div class="stat-content">
                                            <div class="stat-label">Arbeitstage @_year</div>
                                            <div class="stat-value" style="color: #ff9800; font-size: 1.3rem;">@_remainingWorkDays</div>
                                        </div>
                                    </div>
                                </RadzenColumn>
                            </RadzenRow>

                            <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0;" />

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_countWeekendsAndHolidays" Change="@((bool args) => OnToggleCalcChange(args))" />
                                <RadzenLabel Text="Wochenende als Urlaubstage zählen" Style="cursor: pointer; font-size: 0.8rem;" @onclick="@(() => { _countWeekendsAndHolidays = !_countWeekendsAndHolidays; UpdateAllCalculations(); })" />
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                <RadzenCheckBox @bind-Value="_halfDaysChristmas" Change="@((bool args) => OnToggleCalcChange(args))" />
                                <RadzenLabel Style="cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;" @onclick="@(() => { _halfDaysChristmas = !_halfDaysChristmas; UpdateAllCalculations(); })">
                                    24./31.12. als halbe Tage zählen (0,5 Urlaubstage)
                                </RadzenLabel>
                            </RadzenStack>

                            <RadzenSplitButton Text="Vorschlag generieren" Icon="auto_awesome" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium" Click="@(args => SuggestPerfectVacationWithOptions(args))" Style="width: 100%; margin-top: 5px;">
                                <ChildContent>
                                    <RadzenSplitButtonItem Text="Neuplanung (Alles überschreiben)" Icon="autorenew" Value="overwrite" />
                                    <RadzenSplitButtonItem Text="Ergänzen (Bestehendes behalten)" Icon="add" Value="extend" />
                                    <RadzenSplitButtonItem Text="Ab Heute auffüllen" Icon="clock_arrow_down" Value="rest_of_year" />
                                </ChildContent>
                            </RadzenSplitButton>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>



            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeLG="9" SizeXL="10">
        <RadzenCard style="height: 100vh; max-height: 900px; overflow: hidden; padding: 0;">
            <div class="scheduler-scaler">
                <RadzenScheduler @ref="scheduler" TItem="Marking" Culture="@(CultureInfo.GetCultureInfo("de-DE"))"
                                 SlotRender="SlotRender" SlotSelect="SlotSelect" LoadData="LoadData"
                                 style="height: 100%;" StartProperty="Start" EndProperty="End" TextProperty="Name">
                    <RadzenYearPlannerView @ref="yearPlannerView" />
                    <RadzenYearView @ref="yearView" />
                </RadzenScheduler>
            </div>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeLG="3" SizeXL="2">
        <RadzenCard Style="height: 100vh; max-height: 900px; overflow-y: auto;">
            <RadzenStack Gap="1rem">
                @if (!_openHolidaysApiAvailable)
                {
                    <RadzenAlert Severity="AlertSeverity.Warning">
                        <div style="display:flex; gap: 0.75rem; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-weight: 600;">OpenHolidays API offline</div>
                                <div style="opacity: 0.9;">Feiertage/Ferien und Vorschlaege stehen temporaer nicht zur Verfuegung.</div>
                            </div>
                            <RadzenButton Text="Erneut versuchen" Icon="refresh" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Secondary" Click="RetryOpenHolidaysApi" Disabled="@_openHolidaysApiRetryInProgress" IsBusy="@_openHolidaysApiRetryInProgress" />
                        </div>
                    </RadzenAlert>
                }

                <RadzenText TextStyle="TextStyle.H6">Markieren</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: #666; font-size: 0.8rem;">
                    Wähle einen Modus und klicke dann im Kalender.
                </RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Style="flex-wrap: wrap;">
                    <RadzenButton Text="Urlaub" Icon="beach_access" Size="ButtonSize.Small"
                                  ButtonStyle="@(_inputMode == MarkingInputMode.Vacation ? ButtonStyle.Primary : ButtonStyle.Light)"
                                  Variant="Variant.Flat" Click="@(() => _inputMode = MarkingInputMode.Vacation)" />
                    <RadzenButton Text="Gleittag" Icon="event_available" Size="ButtonSize.Small"
                                  ButtonStyle="@(_inputMode == MarkingInputMode.Gleittag ? ButtonStyle.Primary : ButtonStyle.Light)"
                                  Variant="Variant.Flat" Click="@(() => _inputMode = MarkingInputMode.Gleittag)" />
                    <RadzenButton Text="Notiz" Icon="note_alt" Size="ButtonSize.Small"
                                  ButtonStyle="@(_inputMode == MarkingInputMode.Note ? ButtonStyle.Primary : ButtonStyle.Light)"
                                  Variant="Variant.Flat" Click="@(() => _inputMode = MarkingInputMode.Note)" />
                </RadzenStack>

                @if (_inputMode == MarkingInputMode.Note)
                {
                    <RadzenStack Gap="0.25rem" Style="margin-top: 0.5rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: #666; font-size: 0.8rem;">Notiz-Text (für neue Notizen)</RadzenText>
                        <RadzenTextBox @bind-Value="_defaultNoteText" Placeholder="z.B. Arzt, Geburtstag" Style="width: 100%;" />
                    </RadzenStack>
                }

                <hr />

                <RadzenText TextStyle="TextStyle.H6">Details zum Tag</RadzenText>

                <RadzenCard Variant="Variant.Flat" Class="rz-p-2" Style="background-color: #f8f9fa; min-height: 100px;">
                    @if (string.IsNullOrEmpty(_hoveredInfo))
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; font-style: italic;">
                            Fahre mit der Maus über einen Tag im Kalender, um hier Details zu sehen.
                        </RadzenText>
                    }
                    else
                    {
                        <RadzenText Style="white-space: pre-wrap;">@_hoveredInfo</RadzenText>
                    }
                </RadzenCard>

                <hr style="margin: 0.75rem 0;" />

                <RadzenText TextStyle="TextStyle.H6">Legende</RadzenText>
                <RadzenStack Gap="0.5rem">
                    <div class="holiday-legend-item"><RadzenIcon Icon="beach_access" Style="color: #1f8f3a;" /> Urlaub</div>
                    <div class="holiday-legend-item"><RadzenIcon Icon="event_available" Style="color: #0a58ca;" /> Gleittag</div>
                    <div class="holiday-legend-item"><span class="holiday-legend-icon" style="--holiday-icon-url: url('/svg/note_alt_24dp_E3E3E3_FILL0_wght400_GRAD0_opsz24.svg?t=note'); --holiday-icon-filter: invert(83%) sepia(67%) saturate(1787%) hue-rotate(355deg) brightness(101%) contrast(102%);"></span> Notiz</div>

                    <div class="holiday-legend-item"><div class="holiday-legend-color" style="background: transparent; border: 3px solid #dc3545;"></div> Feiertag (Mein BL)</div>
                    <div class="holiday-legend-item"><div class="holiday-legend-color" style="background: transparent; border: 3px solid #6f42c1;"></div> Schulferien (Mein BL)</div>
                    <div class="holiday-legend-item"><div class="holiday-legend-color" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMCAxMCc+PHBvbHlnb24gcG9pbnRzPSc1LDAgMTAsNSA1LDEwJyBzdHlsZT0nZmlsbDpvcmFuZ2U7IG9wYWNpdHk6IDAuOScvPjwvc3ZnPg=='); background-repeat: no-repeat; background-position: center; background-size: contain; border: none;"></div> Brückentag</div>
                    <div class="holiday-legend-item" style="flex-direction: column; align-items: flex-start; gap: 2px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div class="holiday-legend-color" style="background: linear-gradient(to right, rgba(0,255,0,0.3), rgba(255,255,0,0.3), rgba(255,165,0,0.4), rgba(255,0,0,0.5));"></div>
                            <span>Heatmap</span>
                        </div>
                        <span style="font-size: 0.75rem; color: #666; padding-left: 21px;">Zeigt, wie viele Vergleichs-Regionen an diesem Tag Ferien/Feiertage haben (grün = wenige, rot = viele)</span>
                    </div>
                </RadzenStack>

            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {

    RadzenScheduler<Marking> scheduler;
    RadzenYearPlannerView yearPlannerView;
    RadzenYearView yearView;
    DotNetObjectReference<Index>? _objRef;

    // Data from Services
    List<Country> _allAdditionalCountries = [];
    IEnumerable<Country> _filteredAdditionalCountries = new List<Country>();
    IEnumerable<Country> _selectedPublicHolidayCountries = new List<Country>();

    bool _openHolidaysApiAvailable = true;
    bool _openHolidaysApiRetryInProgress;

    List<Subdivision> _allSubdivisions = [];
    IEnumerable<Subdivision> _filteredSubdivisions = new List<Subdivision>();

    Subdivision? _primarySubdivision;
    IEnumerable<Subdivision> _compareSubdivisions = new List<Subdivision>();

    // Toggles
    bool _showPublicHolidays = true;
    bool _showSchoolHolidays = true;
    bool _showBridgeDays = true;
    bool _showHeatmap = true;
    bool _countWeekendsAndHolidays = false;
    bool _halfDaysChristmas = true;

    // Stats
    decimal _totalVacationDays = 30m;
    decimal _plannedDays;
    int _remainingWorkDays;
    int _gleittageCount;
    int _year = DateTime.Now.Year;

    string _hoveredInfo = "";
    string _defaultNoteText = "";


    enum MarkingInputMode
    {
        Vacation,
        Gleittag,
        Note
    }

    MarkingInputMode _inputMode = MarkingInputMode.Vacation;

    // Data Store
    readonly List<Marking> _markings = [];
    readonly List<Marking> _selectedSlots = [];
    readonly List<Marking> _gleittage = [];
    readonly List<Marking> _notes = [];
    readonly Dictionary<DateTime, int> _dailyHeatScore = new();
    readonly HashSet<DateTime> _overBudgetDates = [];

    int _maxDailyHeatScore = 1;
    Dictionary<int, decimal> _vacationDaysPerYear = new();


    protected override async Task OnInitializedAsync()
    {
        var usedBootstrap = false;
        if (OpenHolidaysBootstrapState.Subdivisions is { Count: > 0 } subdivisions && OpenHolidaysBootstrapState.Countries is { Count: > 0 } countries)
        {
            _allSubdivisions = subdivisions;
            _filteredSubdivisions = _allSubdivisions;

            _allAdditionalCountries = countries;
            _filteredAdditionalCountries = _allAdditionalCountries;

            _openHolidaysApiAvailable = true;
            usedBootstrap = true;
        }

        if (!usedBootstrap)
        {
            await RetryOpenHolidaysApi(showNotificationOnFailure: true);
        }
    }

    private async Task RetryOpenHolidaysApi()
    {
        await RetryOpenHolidaysApi(showNotificationOnFailure: false);
    }

    private async Task RetryOpenHolidaysApi(bool showNotificationOnFailure)
    {
        if (_openHolidaysApiRetryInProgress)
        {
            return;
        }

        _openHolidaysApiRetryInProgress = true;
        try
        {
            var wasOffline = !_openHolidaysApiAvailable;

            var countries = await HolidayService.LoadCountriesAsync();
            var subdivisions = await HolidayService.LoadSubdivisionsAsync();

            _openHolidaysApiAvailable = subdivisions.Any();

            _allAdditionalCountries = countries;
            _filteredAdditionalCountries = _allAdditionalCountries;

            _allSubdivisions = subdivisions;
            _filteredSubdivisions = _allSubdivisions;

            if (_openHolidaysApiAvailable)
            {
                OpenHolidaysBootstrapState.Subdivisions = _allSubdivisions;
                OpenHolidaysBootstrapState.Countries = _allAdditionalCountries;
                OpenHolidaysBootstrapState.LoadedAt = DateTimeOffset.Now;

                if (_pendingConfig != null)
                {
                    ApplyConfig(_pendingConfig, applySelections: true);
                    _pendingConfig = null;
                }

                if (wasOffline)
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "OpenHolidays API wieder online",
                        Detail = "Daten wurden neu geladen.",
                        Duration = 4000
                    });
                }

                await GetAllMarkings();
            }
            else if (showNotificationOnFailure)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "OpenHolidays API nicht verfuegbar",
                    Detail = "Der OpenHolidays-Dienst ist aktuell nicht erreichbar (Wartung). Die App startet im Offline-Modus: keine Feiertage/Ferien-Liste, Planung eingeschraenkt.",
                    Duration = 8000
                });
            }

            await InvokeAsync(StateHasChanged);
        }
        finally
        {
            _openHolidaysApiRetryInProgress = false;
        }
    }

    PlanningConfig? _pendingConfig;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var mobile = await JSRuntime.InvokeAsync<bool>("isDevice");
            if (mobile)
            {
                await scheduler.SelectView(yearView);
            }

            // Setup Hover
            _objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("setupSlotHover", _objRef);

            // Load Saved Config
            _pendingConfig = await StateService.LoadConfigAsync();
            if (_pendingConfig != null)
            {
                // Apply everything that doesn't depend on OpenHolidays data.
                ApplyConfig(_pendingConfig, applySelections: false);

                // If data is already available, also apply dropdown selections.
                if (_openHolidaysApiAvailable)
                {
                    ApplyConfig(_pendingConfig, applySelections: true);
                    _pendingConfig = null;
                }
            }
            else
            {
                UpdateAllCalculations();
            }
        }
    }

    [JSInvokable]
    public void OnSlotHover(string title)
    {
        if (_hoveredInfo != title)
        {
            _hoveredInfo = title;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }

    // --- Events Helpers ---
    async Task OnToggleChange(bool value)
    {
        await SaveConfigToStorage();

        if (!_openHolidaysApiAvailable)
        {
            return;
        }

        await GetAllMarkings();
    }

    void OnToggleCalcChange(bool value)
    {
        _ = SaveConfigToStorage(); // Fire and forget
        UpdateAllCalculations();
    }

    void OnNumericChange(decimal value)
    {
        _vacationDaysPerYear[_year] = value;
        _ = SaveConfigToStorage(); // Fire and forget
        UpdateAllCalculations();
    }

    // --- Dropdown Load Data ---

    void OnSubdivisionLoadData(LoadDataArgs args)
    {
        var term = args.Filter?.ToLower();
        _filteredSubdivisions = string.IsNullOrEmpty(term) ? _allSubdivisions : _allSubdivisions.Where(s => s.SearchKeywords.Contains(term));
        InvokeAsync(StateHasChanged);
    }

    void OnCountryLoadData(LoadDataArgs args)
    {
        var term = args.Filter?.ToLower();
        _filteredAdditionalCountries = string.IsNullOrEmpty(term) ? _allAdditionalCountries : _allAdditionalCountries.Where(c => c.SearchKeywords.Contains(term));
        InvokeAsync(StateHasChanged);
    }

    async Task OnPrimaryStateChanged()
    {
        _filteredSubdivisions = _allSubdivisions;
        await SaveConfigToStorage();

        if (!_openHolidaysApiAvailable)
        {
            return;
        }

        await GetAllMarkings();
    }

    async Task OnCompareStatesChanged()
    {
        _filteredSubdivisions = _allSubdivisions;
        await SaveConfigToStorage();

        if (!_openHolidaysApiAvailable)
        {
            return;
        }

        await GetAllMarkings();
    }

    async Task OnCountriesChanged()
    {
        _filteredAdditionalCountries = _allAdditionalCountries;
        await SaveConfigToStorage();

        if (!_openHolidaysApiAvailable)
        {
            return;
        }

        await GetAllMarkings();
    }

    private async Task GetAllMarkings()
    {
        if (!_openHolidaysApiAvailable)
        {
            UpdateAllCalculations();
            await scheduler.Reload();
            return;
        }

        _markings.Clear();
        _dailyHeatScore.Clear();
        _maxDailyHeatScore = 1;

        var startDate = scheduler.SelectedView.StartDate;
        var endDate = scheduler.SelectedView.EndDate;

        if (_primarySubdivision != null)
        {
            if (_showPublicHolidays)
            {
                var ph = await HolidayService.FetchHolidaysCached("DE", startDate, endDate, _primarySubdivision.Code, false);
                foreach (var h in ph) AddMarking(h, _primarySubdivision.Name, MarkingType.PublicHoliday, 3);
            }
            if (_showSchoolHolidays)
            {
                var sh = await HolidayService.FetchHolidaysCached("DE", startDate, endDate, _primarySubdivision.Code, true);
                foreach (var h in sh) AddMarking(h, _primarySubdivision.Name, MarkingType.SchoolHoliday, 1);
            }
        }

        if (_compareSubdivisions != null && _compareSubdivisions.Any())
        {
            foreach (var sub in _compareSubdivisions)
            {
                if (sub.Code == _primarySubdivision?.Code) continue;

                if (_showPublicHolidays)
                {
                    var ph = await HolidayService.FetchHolidaysCached("DE", startDate, endDate, sub.Code, false);
                    foreach (var h in ph) AddMarking(h, sub.Name, MarkingType.PublicHolidayCompare, 2);
                }
                if (_showSchoolHolidays)
                {
                    var sh = await HolidayService.FetchHolidaysCached("DE", startDate, endDate, sub.Code, true);
                    foreach (var h in sh) AddMarking(h, sub.Name, MarkingType.SchoolHolidayCompare, 1);
                }
            }
        }

        if (_selectedPublicHolidayCountries != null && _selectedPublicHolidayCountries.Any())
        {
            foreach (var c in _selectedPublicHolidayCountries)
            {
                if (_showPublicHolidays)
                {
                    var ph = await HolidayService.FetchHolidaysCached(c.IsoCode, startDate, endDate, null, false);
                    foreach (var h in ph.Where(p => p.Nationwide == true)) AddMarking(h, c.Name, MarkingType.PublicHolidayCompare, 2);
                }
            }
        }

        if (_showBridgeDays && _primarySubdivision != null)
        {
            _markings.AddRange(VacationCalculationService.CalculateBridgeDays(startDate, endDate, _markings));
        }

        if (_dailyHeatScore.Any())
        {
            _maxDailyHeatScore = _dailyHeatScore.Values.Max();
        }

        UpdateAllCalculations();
        await scheduler.Reload();
    }

    private void UpdateAllCalculations()
    {
        (_plannedDays, _gleittageCount) = VacationCalculationService.CalculatePlannedDays(
            _selectedSlots,
            _gleittage,
            _markings,
            _halfDaysChristmas);

        _remainingWorkDays = VacationCalculationService.CalculateRemainingWorkDays(
            _year,
            _selectedSlots,
            _gleittage,
            _markings,
            _countWeekendsAndHolidays);

        // Calculate Over Budget Dates (Insertion Order)
        _overBudgetDates.Clear();
        decimal currentCost = 0;

        var primaryHolidays = _markings
            .Where(m => m.Type == MarkingType.PublicHoliday)
            .SelectMany(m => Enumerable.Range(0, (m.End.Date - m.Start.Date).Days + 1).Select(d => m.Start.Date.AddDays(d)))
            .ToHashSet();

        foreach (var slot in _selectedSlots)
        {
            var date = slot.Start.Date;
            var isWeekend = date.DayOfWeek is DayOfWeek.Saturday or DayOfWeek.Sunday;
            var isHoliday = primaryHolidays.Contains(date);

            if (!isWeekend && !isHoliday)
            {
                var cost = (_halfDaysChristmas && (date.Month == 12 && (date.Day == 24 || date.Day == 31))) ? 0.5m : 1.0m;
                currentCost += cost;

                if (currentCost > _totalVacationDays)
                {
                    _overBudgetDates.Add(date);
                }
            }
        }
    }

    private void AddMarking(HolidayResponse h, string subName, MarkingType type, int score)
    {
        if (!h.StartDate.HasValue || !h.EndDate.HasValue) return;

        var start = h.StartDate.Value.Date;
        var end = h.EndDate.Value.Date;

        _markings.Add(new Marking
        {
            Start = start,
            End = end.AddHours(23),
            Name = h.Name.First().Text,
            SubdivisionName = subName,
            Type = type
        });

        for (var d = start; d <= end; d = d.AddDays(1))
        {
            _dailyHeatScore.TryAdd(d, 0);
            _dailyHeatScore[d] += score;
        }
    }

    private string GetHeatmapColor(int score)
    {
        if (score == 0) return "transparent";

        const double saturation = 12.0;
        var denominator = Math.Min(Math.Max(_maxDailyHeatScore, 5), saturation);
        var percent = Math.Min(score / denominator, 1.0);

        int r, g;
        var alpha = 0.3 + (percent * 0.2); // Less opacity overall (0.3 to 0.5)

        // Multi-stop gradient: Green -> Yellow -> Orange -> Red
        // 0.00 - 0.33: Green (0,255,0) -> Yellow (255,255,0)
        // 0.33 - 0.66: Yellow (255,255,0) -> Orange (255,165,0)
        // 0.66 - 1.00: Orange (255,165,0) -> Red (255,0,0)

        switch (percent)
        {
            case < 0.33:
            {
                // Green to Yellow
                var p = percent / 0.33;
                r = (int)(p * 255);
                g = 255;
                break;
            }
            case < 0.66:
            {
                // Yellow to Orange
                var p = (percent - 0.33) / 0.33;
                r = 255;
                g = (int)(255 - (p * (255 - 165))); // G goes 255 -> 165
                break;
            }
            default:
            {
                // Orange to Red
                var p = (percent - 0.66) / 0.34;
                r = 255;
                g = (int)(165 - (p * 165)); // G goes 165 -> 0
                break;
            }
        }

        var b = 0;

        return $"rgba({r}, {g}, {b}, {alpha.ToString(CultureInfo.InvariantCulture)})";
    }

    private static string AppendCssClass(IDictionary<string, object> attributes, string cssClass) => attributes.TryGetValue("class", out var existing) && existing is string s && !string.IsNullOrWhiteSpace(s) ? s.Split(' ', StringSplitOptions.RemoveEmptyEntries).Contains(cssClass) ? s : $"{s} {cssClass}" : cssClass;

    private void SlotRender(SchedulerSlotRenderEventArgs args)
    {
        var date = args.Start.Date;
        var style = new StringBuilder();
        var bgImages = new List<string>();
        var bgPositions = new List<string>();
        var bgSizes = new List<string>();
        var info = new List<string>();

        if (_showHeatmap && _dailyHeatScore.TryGetValue(date, out var score))
        {
            style.Append($"background-color: {GetHeatmapColor(score)};");
        }

        if (date.DayOfWeek is DayOfWeek.Saturday or DayOfWeek.Sunday)
        {
            bgImages.Add("linear-gradient(rgba(0,0,0,0.05), rgba(0,0,0,0.05))");
            bgPositions.Add("center");
            bgSizes.Add("contain");
        }

        var dayMarkings = _markings.Where(m => m.Start.Date <= date && m.End.Date >= date).ToList();

        var primaryPH = dayMarkings.FirstOrDefault(m => m.Type == MarkingType.PublicHoliday);
        if (primaryPH != null)
        {
            style.Append("box-shadow: inset 0 0 0 3px #dc3545;");
            info.Add($"★ {primaryPH.Name}");
        }
        else
        {
            var primarySH = dayMarkings.FirstOrDefault(m => m.Type == MarkingType.SchoolHoliday);
            if (primarySH != null)
            {
                style.Append("box-shadow: inset 0 0 0 3px #6f42c1;");
                info.Add($"Ferien: {primarySH.Name}");
            }
        }

        info.AddRange(dayMarkings.Where(x => x.Type is MarkingType.PublicHolidayCompare or MarkingType.SchoolHolidayCompare).Select(m => $"{m.Name} ({m.SubdivisionName})"));

        var selection = _selectedSlots.FirstOrDefault(s => s.Start.Date == date);
        var gleittag = _gleittage.FirstOrDefault(s => s.Start.Date == date);
        var note = _notes.FirstOrDefault(s => s.Start.Date == date);

        // Icon layout rules:
        // - If note + vacation/gleittag exist: show vacation/gleittag as main icon (bigger, centered), note as small icon on top.
        // - Bridge-day arrows are drawn as background of the cell (not via ::after), so they stay behind icons.
        var hasMain = selection != null || gleittag != null;
        var hasSecondary = note != null && hasMain;

        if (selection != null)
        {
            style.Append("--holiday-icon-url: url('/svg/beach_access_24dp_E3E3E3_FILL0_wght400_GRAD0_opsz24.svg?t=vac');");
            style.Append("--holiday-icon-position: center;--holiday-icon-size: 66%;");

            if (_overBudgetDates.Contains(date))
            {
                style.Append("--holiday-icon-filter: invert(27%) sepia(83%) saturate(1786%) hue-rotate(339deg) brightness(95%) contrast(92%);");
                info.Add("Geplanter Urlaub (Über Budget!)");
            }
            else
            {
                style.Append("--holiday-icon-filter: invert(48%) sepia(73%) saturate(448%) hue-rotate(86deg) brightness(92%) contrast(92%);");
                info.Add("Geplanter Urlaub");
            }
        }
        else if (gleittag != null)
        {
            style.Append("--holiday-icon-url: url('/svg/event_available_24dp_E3E3E3_FILL0_wght400_GRAD0_opsz24.svg?t=gleit');");
            style.Append("--holiday-icon-position: center;--holiday-icon-size: 66%;");
            style.Append("--holiday-icon-filter: invert(35%) sepia(86%) saturate(2351%) hue-rotate(197deg) brightness(96%) contrast(101%);");
            info.Add("Gleittag");
        }
        else if (note != null)
        {
            // Note-only day
            style.Append("--holiday-icon-url: url('/svg/note_alt_24dp_E3E3E3_FILL0_wght400_GRAD0_opsz24.svg?t=note');");
            style.Append("--holiday-icon-position: center;--holiday-icon-size: 62%;");
            style.Append("--holiday-icon-filter: invert(83%) sepia(67%) saturate(1787%) hue-rotate(355deg) brightness(101%) contrast(102%);");
            info.Add(string.IsNullOrWhiteSpace(note.Name) ? "Notiz" : $"Notiz: {note.Name}");
        }

        if (hasSecondary && note != null)
        {
            style.Append("--holiday-icon-url-secondary: url('/svg/note_alt_24dp_E3E3E3_FILL0_wght400_GRAD0_opsz24.svg?t=note');");
            style.Append("--holiday-icon-position-secondary: center 20%;");
            style.Append("--holiday-icon-size-secondary: 44%;");
            style.Append("--holiday-icon-filter-secondary: invert(83%) sepia(67%) saturate(1787%) hue-rotate(355deg) brightness(101%) contrast(102%);");
            info.Add(string.IsNullOrWhiteSpace(note.Name) ? "Notiz" : $"Notiz: {note.Name}");
        }



        if (_showBridgeDays && dayMarkings.Any(m => m.Type == MarkingType.BridgeDay))
        {
            var arrowSvg = date.DayOfWeek switch
            {
                DayOfWeek.Monday or DayOfWeek.Tuesday => "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'><polygon points='5,0 0,5 5,10' style='fill:orange; opacity: 0.9'/></svg>",
                DayOfWeek.Thursday or DayOfWeek.Friday => "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'><polygon points='5,0 10,5 5,10' style='fill:orange; opacity: 0.9'/></svg>",
                _ => ""
            };
            if (!string.IsNullOrEmpty(arrowSvg))
            {
                // Arrow should be behind icons; keep it as a real background layer of the slot.
                bgImages.Add($"url('data:image/svg+xml;base64,{Convert.ToBase64String(Encoding.UTF8.GetBytes(arrowSvg))}')");
                bgPositions.Add("center");
                bgSizes.Add("contain");
                info.Add("Möglicher Brückentag");
            }
        }

        if (date < DateTime.Today)
        {
            style.Append("opacity: 0.5; filter: grayscale(0.5); ");
        }

        if (bgImages.Count > 0)
        {
            style.Append($"background-image: {string.Join(", ", bgImages)};");
            style.Append($"background-position: {string.Join(", ", bgPositions)};");
            style.Append($"background-size: {string.Join(", ", bgSizes)};");
            style.Append("background-repeat: no-repeat;");
        }

        if (selection != null || gleittag != null || note != null)
        {
            args.Attributes["class"] = AppendCssClass(args.Attributes, "holiday-slot-icon");
        }

        args.Attributes["style"] = style.ToString();

        if (info.Any())
        {
            args.Attributes["title"] = string.Join("\n", info.Distinct());
        }
    }

    private async Task SlotSelect(SchedulerSlotSelectEventArgs args)
    {
        args.PreventDefault();
        var date = args.Start.Date;

        var existingSel = _selectedSlots.FirstOrDefault(s => s.Start.Date == date);
        var existingGleit = _gleittage.FirstOrDefault(s => s.Start.Date == date);
        var existingNote = _notes.FirstOrDefault(s => s.Start.Date == date);

        switch (_inputMode)
        {
            case MarkingInputMode.Vacation:
                if (existingSel != null)
                {
                    _selectedSlots.Remove(existingSel);
                }
                else
                {
                    _gleittage.RemoveAll(s => s.Start.Date == date);
                    _selectedSlots.Add(new Marking { Start = date, End = date.AddDays(1), Name = "Urlaub", Type = MarkingType.Selected });
                }
                break;

            case MarkingInputMode.Gleittag:
                if (existingGleit != null)
                {
                    _gleittage.Remove(existingGleit);
                }
                else
                {
                    _selectedSlots.RemoveAll(s => s.Start.Date == date);
                    _gleittage.Add(new Marking { Start = date, End = date.AddDays(1), Name = "Gleittag", Type = MarkingType.Gleittag });
                }
                break;

            case MarkingInputMode.Note:
                if (existingNote != null)
                {
                    _notes.Remove(existingNote);
                }
                else
                {
                    var text = string.IsNullOrWhiteSpace(_defaultNoteText) ? "Notiz" : _defaultNoteText.Trim();
                    _notes.Add(new Marking { Start = date, End = date.AddDays(1), Name = text, Type = MarkingType.Note });
                }
                break;
        }

        await SaveConfigToStorage();
        UpdateAllCalculations();
        await scheduler.Reload();
    }

    async Task LoadConfigFromFile(InputFileChangeEventArgs e)
    {
        try
        {
            using var reader = new StreamReader(e.File.OpenReadStream());
            var json = await reader.ReadToEndAsync();
            var config = StateService.ImportConfigFromJson(json);
            if (config != null)
            {
                ApplyConfig(config, applySelections: true);
                _pendingConfig = null;
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Import erfolgreich", Detail = "Konfiguration wurde geladen." });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Import Fehler", Detail = "Datei konnte nicht gelesen werden." });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Import Fehler", Detail = ex.Message });
        }
    }

    async Task SuggestPerfectVacationWithOptions(RadzenSplitButtonItem? args)
    {
        if (!_openHolidaysApiAvailable)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "OpenHolidays API nicht verfuegbar",
                Detail = "Der OpenHolidays-Dienst ist aktuell nicht erreichbar. Vorschlaege koennen erst nach Wiederverfuegbarkeit generiert werden.",
                Duration = 6000
            });
            return;
        }

        if (_primarySubdivision == null)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = "Fehler", Detail = "Bitte waehlen Sie zuerst Ihr Bundesland aus." });
            return;
        }

        // Default to "extend" if main button clicked (args is null)
        var value = args?.Value ?? "extend";

        var overwrite = value == "overwrite";
        var planFromToday = value == "rest_of_year";

        var preferences = await DialogService.OpenAsync<PlanningPreferencesDialog>("Planungs-Einstellungen", null,
            new DialogOptions { Width = "500px", Height = "auto", Resizable = false, Draggable = true });
        var prefs = (PlanningPreferences)preferences;

        var suggestedBlocks = await VacationCalculationService.SuggestPerfectVacation(
            prefs,
            _primarySubdivision,
            _totalVacationDays,
            _plannedDays,
            _halfDaysChristmas,
            overwrite,
            planFromToday,
            _year,
            _selectedSlots.ToList(),
            _notes.ToList()
        );

        if (suggestedBlocks.Any())
        {
            var result = await DialogService.OpenAsync<SuggestionDialog>("Optimaler Urlaubsplan",
                new Dictionary<string, object> { { "SuggestionBlocks", suggestedBlocks } },
                new DialogOptions { Width = "90vw", Height = "auto", Resizable = true, Draggable = true });

            if (result == true)
            {
                if (overwrite)
                {
                    _selectedSlots.Clear();
                    _gleittage.Clear();
                    _notes.Clear();
                }
                var allSuggestedDays = suggestedBlocks.SelectMany(b => b.VacationDays);
                foreach (var day in allSuggestedDays)
                {
                    if (_selectedSlots.All(s => s.Start.Date != day.Date))
                    {
                        _selectedSlots.Add(new Marking { Start = day.Date, End = day.Date.AddDays(1), Name = "Urlaub", Type = MarkingType.Selected });
                    }
                }

                await SaveConfigToStorage();
                UpdateAllCalculations();
                await scheduler.Reload();
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Kein Vorschlag", Detail = "Es konnten keine passenden Zeiträume für die gewählten Kriterien gefunden werden.", Duration = 4000 });
        }
    }

    async Task ClearAllSelections()
    {
        var result = await DialogService.Confirm("Möchten Sie wirklich alle Planungen löschen?", "Planung zurücksetzen", new ConfirmOptions() { OkButtonText = "Ja", CancelButtonText = "Nein" });
        if (result == true)
        {
            _selectedSlots.Clear();
            _gleittage.Clear();
            _notes.Clear();
            await SaveConfigToStorage();
            UpdateAllCalculations();
            await scheduler.Reload();

        }
    }

    async Task LoadData(SchedulerLoadDataEventArgs args)
    {
        var middle = args.Start.AddTicks((args.End - args.Start).Ticks / 2).Year;
        if (_year != middle)
        {
            _year = middle;

            // Switch vacation days context
            _vacationDaysPerYear.TryAdd(_year, 30);
            // Default
            _totalVacationDays = _vacationDaysPerYear[_year];

            await GetAllMarkings();
            UpdateAllCalculations();
        }
    }

    // --- Import/Export & Config ---

    async Task SaveConfigToStorage()
    {
        var config = new PlanningConfig
        {
            PrimarySubdivisionCode = _primarySubdivision?.Code,
            CompareSubdivisionCodes = _compareSubdivisions?.Select(s => s.Code).ToList(),
            CountryCodes = _selectedPublicHolidayCountries?.Select(c => c.IsoCode).ToList(),
            ShowPublicHolidays = _showPublicHolidays,
            ShowSchoolHolidays = _showSchoolHolidays,
            ShowBridgeDays = _showBridgeDays,
            ShowHeatmap = _showHeatmap,
            CountWeekendsAndHolidays = _countWeekendsAndHolidays,
            HalfDaysChristmas = _halfDaysChristmas,
            TotalVacationDaysPerYear = _vacationDaysPerYear,
            SelectedSlots = _selectedSlots.Select(s => new MarkingDto { Start = s.Start, End = s.End, Name = s.Name, Type = (int)s.Type }).ToList(),
            Gleittage = _gleittage.Select(s => new MarkingDto { Start = s.Start, End = s.End, Name = s.Name, Type = (int)s.Type }).ToList(),
            Notes = _notes.Select(s => new MarkingDto { Start = s.Start, End = s.End, Name = s.Name, Type = (int)s.Type }).ToList()
        };
        await StateService.SaveConfigAsync(config);
    }

    void ApplyConfig(PlanningConfig config, bool applySelections)
    {
        if (applySelections)
        {
            if (config.PrimarySubdivisionCode != null)
                _primarySubdivision = _allSubdivisions.FirstOrDefault(s => s.Code == config.PrimarySubdivisionCode);

            if (config.CompareSubdivisionCodes != null)
                _compareSubdivisions = _allSubdivisions.Where(s => config.CompareSubdivisionCodes.Contains(s.Code)).ToList();

            if (config.CountryCodes != null)
                _selectedPublicHolidayCountries = _allAdditionalCountries.Where(c => config.CountryCodes.Contains(c.IsoCode)).ToList();
        }

        _showPublicHolidays = config.ShowPublicHolidays;
        _showSchoolHolidays = config.ShowSchoolHolidays;
        _showBridgeDays = config.ShowBridgeDays;
        _showHeatmap = config.ShowHeatmap;
        _countWeekendsAndHolidays = config.CountWeekendsAndHolidays;
        _halfDaysChristmas = config.HalfDaysChristmas;

        _vacationDaysPerYear = config.TotalVacationDaysPerYear ?? new Dictionary<int, decimal>();

        // Fallback for migration
        if (!_vacationDaysPerYear.ContainsKey(_year))
        {
            _vacationDaysPerYear[_year] = config.TotalVacationDays > 0 ? config.TotalVacationDays : 30;
        }
        _totalVacationDays = _vacationDaysPerYear.GetValueOrDefault(_year, 30);

        _selectedSlots.Clear();
        if (config.SelectedSlots != null)
            _selectedSlots.AddRange(config.SelectedSlots.Select(d => new Marking { Start = d.Start, End = d.End, Name = d.Name, Type = (MarkingType)d.Type }));

        _gleittage.Clear();
        if (config.Gleittage != null)
            _gleittage.AddRange(config.Gleittage.Select(d => new Marking { Start = d.Start, End = d.End, Name = d.Name, Type = (MarkingType)d.Type }));

        _notes.Clear();
        if (config.Notes != null)
            _notes.AddRange(config.Notes.Select(d => new Marking { Start = d.Start, End = d.End, Name = d.Name, Type = (MarkingType)d.Type }));

        _ = GetAllMarkings();
    }

    async Task Export(RadzenSplitButtonItem? args)
    {
        if (args == null) return; // Do nothing if main button clicked without a specific value

        if (args.Value == "config_json")
        {
            await SaveConfigToStorage(); // Ensure latest state
            var config = await StateService.LoadConfigAsync();
            if (config != null)
            {
                var cfgExportDate = DateTime.Now;
                var cfgExportStamp = cfgExportDate.ToString("yyyy-MM-dd_HHmm", CultureInfo.InvariantCulture);
                var cfgYearStamp = _year.ToString(CultureInfo.InvariantCulture);
                var json = StateService.ExportConfigToJson(config);
                await ExportService.DownloadFile($"Urlaubsplaner_Config_{cfgYearStamp}_{cfgExportStamp}.json", "application/json", json);
            }
            return;
        }

        var result = await DialogService.OpenAsync<ExportOptionsDialog>("Export-Optionen", null,
            new DialogOptions { Width = "420px", Height = "auto", Resizable = false, Draggable = true });

        var options = (ExportOptionsDialog.ExportOptions)result;

        var items = new List<ExportService.ExportItem>();

        if (options.ExportVacation)
        {
            items.AddRange(_selectedSlots.Select(s => new ExportService.ExportItem
            {
                Start = s.Start.Date,
                End = s.Start.Date,
                Title = "Urlaub",
                Category = "Urlaub"
            }));
        }

        if (options.ExportGleittage)
        {
            items.AddRange(_gleittage.Select(s => new ExportService.ExportItem
            {
                Start = s.Start.Date,
                End = s.Start.Date,
                Title = "Gleittag",
                Category = "Gleittag"
            }));
        }

        if (options.ExportNotes)
        {
            items.AddRange(_notes.Select(s => new ExportService.ExportItem
            {
                Start = s.Start.Date,
                End = s.Start.Date,
                Title = string.IsNullOrWhiteSpace(s.Name) ? "Notiz" : s.Name,
                Category = "Notiz"
            }));
        }

        if (!items.Any())
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = "Nichts zu exportieren", Detail = "Bitte wählen Sie mindestens eine Kategorie mit Daten." });
            return;
        }

        var exportDate = DateTime.Now;
        var exportStamp = exportDate.ToString("yyyy-MM-dd_HHmm", CultureInfo.InvariantCulture);
        var yearStamp = _year.ToString(CultureInfo.InvariantCulture);

        var selectionStamp = options switch
        {
            { ExportVacation: true, ExportGleittage: false, ExportNotes: false } => "Urlaub",
            { ExportVacation: true, ExportGleittage: true, ExportNotes: false } => "Urlaub+Gleittage",
            { ExportVacation: true, ExportGleittage: true, ExportNotes: true } => "Urlaub+Gleittage+Notizen",
            { ExportVacation: true, ExportGleittage: false, ExportNotes: true } => "Urlaub+Notizen",
            { ExportVacation: false, ExportGleittage: true, ExportNotes: false } => "Gleittage",
            { ExportVacation: false, ExportGleittage: true, ExportNotes: true } => "Gleittage+Notizen",
            { ExportVacation: false, ExportGleittage: false, ExportNotes: true } => "Notizen",
            _ => "Leer"
        };

        var baseFileName = $"Urlaubsplaner_{yearStamp}_{selectionStamp}_{exportStamp}";

        switch (args.Value)
        {
            case "ics":
                var ics = ExportService.GenerateIcs(items);
                await ExportService.DownloadFile($"{baseFileName}.ics", "text/calendar", ics);
                break;
            case "csv":
                var csv = ExportService.GenerateCsv(items);
                await ExportService.DownloadFile($"{baseFileName}.csv", "text/csv", csv);
                break;
            case "json":
                var json = ExportService.GenerateJson(items);
                await ExportService.DownloadFile($"{baseFileName}.json", "application/json", json);
                break;
            case "clipboard":
                var text = ExportService.GenerateSummaryText(items);
                await ExportService.CopyToClipboard(text);
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Kopiert", Detail = "Exportdaten in Zwischenablage kopiert." });
                break;
            case "print":
                await JSRuntime.InvokeVoidAsync("print");
                break;
        }
    }

    void ShowTooltip(ElementReference elementReference, string text, TooltipOptions options = null) => tooltipService.Open(elementReference, text, options);
}